---
title: A data wrangling case with spreadsheets using R
author: Cristóbal Alcázar
date: '2018-01-16'
slug: a-data-wrangling-case-with-r
categories: [R]
tags: [R, Data-Science]
comments: yes
showcomments: yes
showpagemeta: yes
---

## Introduction 

Data wrangling is the process of mapping raw data to a format more suitable to model, visualize or in general to work it. This process is usually thought as an early stage of the data analysis pipeline (*i.e. I need a nice table to start the analysis*). But the skills involved in the process are useful whenever you need to reshape, try to look your data from different perspectives or when you need to adapt some new tool that required a specific format. The reflexion is: **data wrangling skills have more to say that only in an initial stage of the analysis, it can be augmented with these skills, enabling more flexibility and expressiveness in the whole pipeline**.

But more than the reflexion, the reason of this post is to show the essential of data wrangling: dominate data or take control of it. As you know, data in real life aren't always friendly, is not uncommon to found problems with the shape or/and format how came data. And one of these type of problems are the spreadsheets kind.

![](img/spreadsheet_shock.jpg#center){ width=60% }

To be fair not all the spreadsheets are a problem. Let me clarify what I refer for "problem", the mess of more than one table per sheet like islands floating in a ocean of blank cells with clouds of metainformation headers relative to the tables...ok


You can look by yourself what I try to say in the following magistral example, but let me give you some context before that. Below of this paragraph you can find a series of tweets belonged to very well known data scientists (*if you don't hear about them, I strongly recommend that you follow them*). The discussion is about a challenge to turn <a href="https://t.co/v9ucC0Vj2t" target="_blank">this spreadsheet</a> (a xlsx file) into a tidy data--*the grace is that the spreadsheet suffer the problems that I tried to describe*--and <a href="http://varianceexplained.org/" target="_blank">David Robinson (*the challenged*) </a>deal with the problem in  <a href="http://rpubs.com/dgrtwo/tidying-enron" target="_blank">a very simple and fluently way</a>.

`r blogdown::shortcode('tweet', '717815339480977410#center')`

`r blogdown::shortcode('tweet', '718170667573579776')`

So in the rest of the post I will dedicate to highlight some steps of the David Robinson answer to the tweet challenge, and then apply the insights on a case of data contained in multiple xlsx files with many sheets.

## The highlights steps

### Step 1: The coordinate-form

Consider the next innocent table as an example.

![](img/murdervictims.png#center){ width=65% }

It's easy to import the above spreadsheet with the `readxl::read_excel` function and obtain a rectangular table in R, filled with missing values (NA) instead of blank cells. You can take a look of the first six rows.

```{r, eval=FALSE}
library(readxl)
df <- readxl::read_excel("./innocent_table.xlsx")
head(df)
```

```{r, echo=FALSE}
colA <- c("Expanded Homicide Data Table 8", "Murder Victims", "by Weapon, 2004-2008", "Weapons", "Total", "Total firearms:", "Handguns", "Rifles", "Shotguns", "Other guns", "Firearms, type not stated", "Knives or cutting instruments", "Blunt objetcs (clubs, hammers, etc)", "Personal weapons (hands, fist, feet, etc)1", "Poison", "Explosives", "Fire", "Narcotics", "Drowning", "Strangulation", "Asphyxiation", "Other weapons or weapons not stated", "1 Pushed is included in personal weapons")
colB <- c(NA, NA, NA, 2004, 14210, 9385, 7286, 403, 507, 117, 1072, 1866, 667, 
          943, 13, 1, 118, 80, 16, 156, 109, 856, NA)
colC <- c(NA, NA, NA, 2005, 14965, 10158, 7565, 445, 522, 138, 1488, 1920, 608,
          905, 9, 2,  125, 46, 20, 118, 96, 958, NA)
colD <- c(NA, NA, NA, 2006, 15087, 10225, 7836, 438, 490, 107, 1354, 1830, 618, 
          841, 12, 1, 117, 48, 12, 137, 106, 1140, NA)
colE <- c(NA, NA, NA, 2007, 14916, 10129, 7398, 453, 457, 116, 1705, 1817, 647, 869, 
          10, 1, 131, 52, 12, 134, 109, 1005, NA)
colF <- c(NA, NA, NA, 2008, 14180, 9484, 6755, 375, 444, 79, 1831, 1897, 614, 861,
          10, 10, 86, 33, 15, 88, 89, 993, NA)
example <- data.frame(X1 = colA, X2 = colB, X3 = colC, X4 = colD, X5 = colE, X6 = colF)
head(example)
```



The importance of this step is to describe explicitly the position of each cell-value of the spreadsheet into the R's data frame--*in row* $i$ *and column* $j$ *you found the value* $x_{i,j}$--and the following function reorganize the data accordingly.

```{r}
library(dplyr)
library(tidyr)
tidy_excel <- function(x) {
  #
  # Take a data frame imported from the spreadsheet and make
  # explicit, in the data frame, the position of each value
  #
  x %>% 
    setNames(seq_len(ncol(x))) %>% 
    mutate(row = row_number()) %>% 
    tidyr::gather(column, value, -row) %>% 
    mutate(column = as.integer(column)) %>% 
    group_by(row) %>% 
    filter(!all(is.na(value))) %>% 
    group_by(column) %>% 
    filter(!all(is.na(value))) %>% 
    ungroup() %>% 
    arrange(column, row)
}

tidy_excel(example)
```

As you can observe, two new index-columns are created, one by each dimension (rows and columns). In this way, all the original columns can be express as values of these two dimensions. 

- **Q:** *Why can be useful this coordinate form?*

- **A:** *It's possible to take advantage of manipulate the data based on the physical position of the template using operations over the columns and the rows. In fact,* `tidy_excel` *apart of reshape data into the coordinate form is also an example of this. Pay attention to this code snippet.*

```{r, eval = FALSE}
# ...from the definition of tidy_excel
  group_by(row) %>%  # group by row index
  filter(!all(is.na(value))) %>%  # discard empty rows (row-groups that contain only NA values)
  group_by(column) %>%  # group by col index
  filter(!all(is.na(value))) # discard empty cols (col-groups that contain only NA values)
```

Another useful reason of the coordinate-form is explain in the next step.

### Step 2: Make your shot with regex


<iframe src="https://giphy.com/embed/VIikhF8kK7eFO" width="480" height="313" frameBorder="0" align="middle"></iframe><p><a href="https://giphy.com/gifs/video-games-assassins-creed-iv-black-flag-VIikhF8kK7eFO"></a></p>

## The Case

